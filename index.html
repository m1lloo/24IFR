<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>24IFR Clearance Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-body: #0f0f0f;
      --bg-card: #1b1b1b;
      --text-color: #fff;
      --accent: #00bfff;
    }
    [data-theme="light"] {
      --bg-body: #f5f5f5;
      --bg-card: #fff;
      --text-color: #111;
      --accent: #0099cc;
    }

    body {
      background-color: var(--bg-body);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text-color);
    }

    .card {
      background-color: var(--bg-card);
      border-radius: 15px;
      padding: 35px 30px;
      width: 100%;
      max-width: 650px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
      transition: transform 0.2s ease;
      color: var(--text-color);
    }

    h2 { text-align:center; font-weight:700; margin-bottom:30px; color:var(--accent); }

    label { font-weight:600; margin-bottom:8px; display:block; color:var(--text-color); }

    input, textarea, select {
      background-color: var(--bg-card);
      border:1px solid #444;
      border-radius:8px;
      color: var(--text-color);
      padding:10px 12px;
      font-size:0.95rem;
      width:100%;
      transition:border-color 0.2s ease, background 0.2s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline:none;
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(0,191,255,0.3);
    }

    .btn-primary {
      background: var(--accent);
      border:none;
      padding:12px;
      font-weight:700;
      width:100%;
      font-size:1rem;
      border-radius:10px;
      margin-top:15px;
      transition: transform 0.1s ease, background 0.2s ease;
      cursor:pointer;
    }
    .btn-primary:hover { background:#0099cc; }
    .btn-primary:active { transform: scale(0.95); }

    .btn-discord {
      background-color: #7289da;
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      display: inline-block;
      transition: background 0.2s, transform 0.1s;
      margin-top: 20px;
      text-align: center;
    }
    .btn-discord:hover { background-color: #5b6eae; transform: translateY(-2px); }

    .form-group { margin-bottom: 20px; }

    #output {
      font-family: monospace;
      background-color: var(--bg-card);
      border:1px solid #444;
      border-radius:10px;
      min-height:120px;
      resize:none;
      padding:12px;
      color: var(--text-color);
    }

    .muted-small { color:#9aa; font-size:0.85rem; margin-top:6px; display:block; }

    /* Dark/Light toggle label */
    #themeToggleLabel {
      cursor:pointer;
      color: var(--text-color);
      font-weight:600;
      display:block;
      text-align:right;
      margin-bottom:10px;
    }
    #themeToggle { display:none; }
  </style>
</head>

<div id="updateModal" 
     style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999;">
  <div style="background:var(--bg-card); padding: 30px; border-radius: 12px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.6);">
    <h3 style="color: var(--accent); font-weight: 700; margin-bottom: 10px;">üîÑ Update Available</h3>
    <p style="color: var(--text-color); font-size: 0.95rem; margin-bottom: 20px;">
      A new version of 24IFR is available.<br>
      Please refresh the page to continue.<br>
      Apologies for any disruption :-)
    </p>
    <button onclick="location.reload(true);" style="background: var(--accent); border:none; padding: 12px 20px; font-size:1rem; font-weight:700; border-radius: 8px; cursor:pointer; width:100%;">Refresh Now</button>
  </div>
</div>

<script>
  const CURRENT_VERSION = "0.2.0";
  async function checkVersion(){
    try {
      const res = await fetch("/version.json?cacheBust=" + Date.now());
      const data = await res.json();
      if (data.version !== CURRENT_VERSION) {
        document.getElementById("updateModal").style.display = "flex";
      }
    } catch (err) {
      console.error("Version check failed:", err);
    }
  }
  setInterval(checkVersion, 5000);
</script>

<body>
  <div class="card">
    <label id="themeToggleLabel">
      üåô/‚òÄÔ∏è
      <input type="checkbox" id="themeToggle">
    </label>

    <h2>24IFR Clearance Generator</h2>

    <div class="form-group">
      <label for="fpInput">Flight Plan Info</label>
      <textarea id="fpInput" placeholder="Discord: @user&#10;Roblox: username&#10;Callsign: XXX&#10;Aircraft: B787&#10;Flight Rules: IFR&#10;Departing: IRFD&#10;Arriving: ITKO&#10;Route: N/A&#10;Flight Level: 040" rows="6"></textarea>
      <span class="muted-small">Use the same FP format as the placeholder. Only Callsign & Departing are required for VFR.</span>
    </div>

    <div class="form-group">
      <label for="clrType">Clearance Type</label>
      <select id="clrType">
        <option value="IFR">IFR Clearance</option>
        <option value="VFR">VFR Clearance</option>
      </select>
    </div>

    <div class="form-group">
      <label for="atisAirport">ATIS Airport ICAO</label>
      <select id="atisAirport">
        <option value="">Select Airport</option>

        <optgroup label="Rockford">
          <option value="IRFD">IRFD ‚Äî Rockford</option>
          <option value="IMLR">IMLR ‚Äî Mellor</option>
          <option value="IGAR">IGAR ‚Äî Garry</option>
          <option value="IBLT">IBLT ‚Äî Boltic</option>
          <option value="ITRC">ITRC ‚Äî Training Centre</option>
        </optgroup>

        <optgroup label="Cyprus">
          <option value="ILAR">ILAR ‚Äî Larnaca</option>
          <option value="IPAP">IPAP ‚Äî Paphos</option>
          <option value="IIAB">IIAB ‚Äî McConnell</option>
          <option value="IHEN">IHEN ‚Äî Henstridge</option>
          <option value="IBAR">IBAR ‚Äî Barra</option>
        </optgroup>

        <optgroup label="Izolirani">
          <option value="IZOL">IZOL ‚Äî Izolirani</option>
          <option value="IJAF">IJAF ‚Äî Al Najaf</option>
          <option value="ISCM">ISCM ‚Äî Scampton</option>
        </optgroup>

        <optgroup label="Orenji">
          <option value="ITKO">ITKO ‚Äî Tokyo</option>
          <option value="IDCS">IDCS ‚Äî Saba</option>
        </optgroup>

        <optgroup label="Perth">
          <option value="IPPH">IPPH ‚Äî Perth</option>
          <option value="ILKL">ILKL ‚Äî Lukla</option>
        </optgroup>

        <optgroup label="Saint Barth√©lemy">
          <option value="IBTH">IBTH ‚Äî Saint Barth√©lemy</option>
          <option value="ISKP">ISKP ‚Äî Skopelos</option>
        </optgroup>

        <optgroup label="Grindavik">
          <option value="IGRV">IGRV ‚Äî Grindavik</option>
        </optgroup>

        <optgroup label="Sauthemptona">
          <option value="ISAU">ISAU ‚Äî Sauthemptona</option>
        </optgroup>

      </select>
    </div>

    <div class="form-group">
      <label for="atisLetter">ATIS Info Letter</label>
      <select id="atisLetter">
        <option value="">Select Letter</option>
        <option>A</option><option>B</option><option>C</option><option>D</option>
        <option>E</option><option>F</option><option>G</option><option>H</option>
        <option>I</option><option>J</option><option>K</option><option>L</option>
        <option>M</option><option>N</option><option>O</option><option>P</option>
        <option>Q</option><option>R</option><option>S</option><option>T</option>
        <option>U</option><option>V</option><option>W</option><option>X</option>
        <option>Y</option><option>Z</option>
      </select>
    </div>

    <div class="form-group">
      <label for="depRunways">Departure Runways (comma-separated)</label>
      <input type="text" id="depRunways" placeholder="e.g., 7C, 7L, 7R">
    </div>

    <div class="form-group">
      <label for="arrRunways">Arrival Runways (comma-separated)</label>
      <input type="text" id="arrRunways" placeholder="e.g., 7L, 7C, 7R">
    </div>

    <div class="form-group">
      <label for="depFreq">Departure Frequency</label>
      <select id="depFreq">
        <option value="">Select a frequency</option>
      </select>
    </div>

    <button class="btn btn-primary" id="generateBtn">Generate IFR Clearance</button>

    <div class="form-group mt-3">
      <label id="outputLabel" for="output">Generated IFR Clearance</label>
      <textarea id="output" readonly></textarea>
    </div>

    <a href="https://discord.gg/TEtM5DVbRa" target="_blank" class="btn-discord">üí¨ Join the Discord</a>
  </div>

  <script>

    const toggle = document.getElementById("themeToggle");
    toggle.addEventListener("change", () => {
      if(toggle.checked){
        document.documentElement.setAttribute("data-theme","light");
        localStorage.setItem("theme","light");
      } else {
        document.documentElement.setAttribute("data-theme","dark");
        localStorage.setItem("theme","dark");
      }
    });
    if(localStorage.getItem("theme") === "light") {
      toggle.checked = true;
      document.documentElement.setAttribute("data-theme","light");
    }


    const frequencies = {
      IRFD: ["IRCC 124.850", "IRFD_TWR 118.100"],
      IMLR: ["IRCC 124.850", "IMLR_TWR 133.850"],
      IGAR: ["IRCC 124.850", "IGAR_TWR 125.600"],
      IBLT: ["IRCC 124.850", "IBLT_TWR 120.250"],
      ITRC: ["IRCC 124.850", "ITRC_TWR 119.150"],

      ILAR: ["ICCC 126.300", "ILAR_TWR 121.200"],
      IPAP: ["ICCC 126.300", "IPAP_TWR 119.900"],
      IIAB: ["ICCC 126.300", "IIAB_TWR 127.250"],
      IHEN: ["ICCC 126.300", "IHEN_TWR 130.000"],
      IBAR: ["ICCC 126.300", "IBAR_TWR 118.750"],

      IZOL: ["IZCC 125.650", "IZOL_TWR 118.700"],
      IJAF: ["IZCC 125.650", "IJAF_TWR 119.100"],
      ISCM: ["IZCC 125.650", "ISCM_TWR 121.300"],

      ITKO: ["IOCC 132.300", "ITKO_TWR 118.800"],
      IDCS: ["IOCC 132.300", "IDCS_TWR 118.250"],

      IPPH: ["IPCC 135.250", "IPPH_TWR 127.400"],
      ILKL: ["IPCC 135.250", "ILKL_TWR 120.000"],

      IBTH: ["IBCC 128.600", "IBTH_TWR 118.700"],
      ISKP: ["IBCC 128.600", "ISKP_TWR 123.250"],

      IGRV: ["IGCC 126.750", "IGRV_TWR 118.300"],

      ISAU: ["ISCC 127.825", "ISAU_TWR 118.200"]
    };


    const atisAirportSelect = document.getElementById("atisAirport");
    const depFreqSelect = document.getElementById("depFreq");
    const clrTypeSelect = document.getElementById("clrType");
    const generateBtn = document.getElementById("generateBtn");
    const outputEl = document.getElementById("output");
    const outputLabel = document.getElementById("outputLabel");


    function updateDepartureFrequencies() {
      const airport = atisAirportSelect.value.trim();
      depFreqSelect.innerHTML = '<option value="">Select a frequency</option>';

      if (!airport || !frequencies[airport]) return;

      frequencies[airport].forEach(freq => {
        const opt = document.createElement("option");
        opt.value = freq;
        opt.textContent = freq;
        depFreqSelect.appendChild(opt);
      });
    }

    function getInitialAltitude(fl) {
      return fl > 30 ? 2000 : 1000;
    }

    function getInitialClimbMinutes(fl) {
      if (isNaN(fl)) return 2;
      if (fl < 20) return 1;
      if (fl < 40) return 2;
      if (fl < 60) return 3;
      if (fl < 80) return 4;
      return 5;
    }

    function generateSquawk() {
      return Math.floor(1000 + Math.random() * 9000);
    }

    function pickRunway(runways) {
      const runwayArray = (runways || '').split(',').map(r => r.trim()).filter(r => r);
      if (runwayArray.length === 0) return 'UNKNOWN';
      return runwayArray[Math.floor(Math.random() * runwayArray.length)];
    }

    function tidyString(s){
      return (s || '').toString().trim();
    }

    function generateVFRClearance({callsign, depAirport, depRunways, routeProvided, depFreqAuto}) {
      const runway = pickRunway(depRunways);
      const circuitSide = Math.random() < 0.5 ? "LEFT" : "RIGHT";
      const squawk = generateSquawk();
 
      if (routeProvided && routeProvided.toUpperCase() !== 'N/A') {

        return `${callsign}, ${depAirport} Clearance, cleared to ${routeProvided} via visual, expect runway ${runway} for departure, not above 1000 feet, report DOWNWIND with intentions, squawk ${squawk}${depFreqAuto ? `, departure frequency ${depFreqAuto}` : ''}`;
      } else {

        return `${callsign}, ${depAirport} Clearance, cleared visual circuits, expect runway ${runway} for departure, enter ${circuitSide} visual circuits, not above 1000 feet, report DOWNWIND with intentions, squawk ${squawk}${depFreqAuto ? `, departure frequency ${depFreqAuto}` : ''}`;
      }
    }


    function generateIFRClearance({callsign, aircraft, fl, depAirport, arrAirport, route, atisAirport, atisLetter, depRunways, depFreq}) {
      const initialAltitude = getInitialAltitude(fl);
      const initialClimbMin = getInitialClimbMinutes(fl);
      const squawk = generateSquawk();
      const departureRunway = pickRunway(depRunways);
      const routeText = (route && route.toUpperCase() !== 'N/A') ? route : 'radar vectors';
      const atis = atisAirport || depAirport;
      const letter = atisLetter || 'X';
      const freq = depFreq || 'Tower';

      return `${callsign}, ${atis} Clearance, Cleared to ${arrAirport} via ${routeText},
maintain ${initialAltitude} feet, expect FL${(fl||0).toString().padStart(3,'0')} ${initialClimbMin} minutes after departure,
departure runway ${departureRunway}, departure frequency ${freq},
squawk ${squawk}
Advise you have Information ${letter} on board.`;
    }

  
    atisAirportSelect.addEventListener("change", updateDepartureFrequencies);

    
    clrTypeSelect.addEventListener("change", () => {
      const t = clrTypeSelect.value === "VFR" ? "Generate VFR Clearance" : "Generate IFR Clearance";
      generateBtn.textContent = t;
      outputLabel.textContent = clrTypeSelect.value === "VFR" ? "Generated VFR Clearance" : "Generated IFR Clearance";
    });


    generateBtn.addEventListener("click", () => {
      const fp = document.getElementById('fpInput').value || '';
      const callsign = (fp.match(/Callsign:\s*(.+)/i) || [])[1]?.trim();
      const aircraft = (fp.match(/Aircraft:\s*(.+)/i) || [])[1]?.trim();
      const flRaw = (fp.match(/Flight Level:\s*(\d+)/i) || [])[1];
      const fl = flRaw ? parseInt(flRaw, 10) : NaN;
      const depAirportFP = (fp.match(/Departing:\s*(.+)/i) || [])[1]?.trim();
      const arrAirport = (fp.match(/Arriving:\s*(.+)/i) || [])[1]?.trim();
      const routeMatch = (fp.match(/Route:\s*(.+)/i) || [])[1]?.trim();

      const clrType = clrTypeSelect.value;
      const atisAirport = document.getElementById('atisAirport').value || depAirportFP || '';
      const atisLetter = document.getElementById('atisLetter').value || '';
      const depRunways = document.getElementById('depRunways').value || '';
      const arrRunways = document.getElementById('arrRunways').value || '';
      const depFreq = document.getElementById('depFreq').value || '';

      if (!callsign) {
        outputEl.value = "Invalid flight plan format: missing Callsign.";
        return;
      }

      if (clrType === "VFR") {
        const depAirport = atisAirport || depAirportFP;
        if (!depAirport) {
          outputEl.value = "Invalid flight plan format: missing Departing airport (required for VFR).";
          return;
        }

        const routeProvided = routeMatch && routeMatch.toUpperCase() !== 'N/A' ? routeMatch : null;
        const depFreqAuto = depFreq || null;

        const vfr = generateVFRClearance({
          callsign,
          depAirport,
          depRunways,
          routeProvided,
          depFreqAuto
        });
        outputEl.value = vfr;
        return;
      }

      if (!aircraft || isNaN(fl) || !depAirportFP || !arrAirport || !routeMatch) {
        outputEl.value = "Invalid flight plan format. For IFR please include Callsign, Aircraft, Flight Level, Departing, Arriving and Route fields.";
        return;
      }

      const ifr = generateIFRClearance({
        callsign,
        aircraft,
        fl,
        depAirport: depAirportFP,
        arrAirport,
        route: routeMatch,
        atisAirport,
        atisLetter,
        depRunways,
        depFreq
      });

      outputEl.value = ifr;
    });

    (function init(){
      clrTypeSelect.dispatchEvent(new Event('change'));
      updateDepartureFrequencies();
    })();
  </script>
</body>
</html>
